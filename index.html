<!DOCTYPE html>
<html lang="en">
	<head>
    <meta charset="utf-8"/>
    <meta name="Description" content="Stats Collector">
    <meta name="theme-color" content="#FFCF07">
    <meta name="msapplication-TileColor" content="#FFCF07">

    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#FFCF07">

    <link rel="stylesheet" href="style.css" >

  	<script src="jquery-3.4.0.min.js"></script>

    <title>Stats Collector</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>
	<body id="projector">

		<div id="homepage" class="screen last-el-bottom">
			<h1>Welcome! </h1>
			<p>Welcome message.... Team based? This might be hard to do with version 1 - unless we encode it into the URL  something like: index.html#onboarding="Hi there team!"</p>

			<div>
				<button class="bottom-button" onclick="location.hash = 'locations';">Add Stats</button>
			</div>
		</div>

		<div id="onboarding" class="screen last-el-bottom">
			<h1>Welcome! </h1>
			<p>Select the movements below that you would like to add stats for.  Once this is setup your device will remember your preferences</p>
			<form class="last-el-bottom" id="onboard-form">
				<h2>Movements</h2>

				<div id="movements">
					<input id="one" name="888232" type="checkbox" >
					<label for="one" >University at Buffalo</label>	
					<input id="two" name="923929" type="checkbox" >
					<label for="two" >Daemen</label>
				</div>
				<input id="name" name="name" type="text" required placeholder="Name">
				<input id="phone" name="phone" type="tel" required placeholder="Phone">
				<div>
					<input id="ua" name="ua" required type="checkbox" >
					<label for="ua" >I agree to the <a href="http://google.com" target="_blank">Cru User Agreement</a></label>
				</div>
				<div>
					<button class="bottom-button">Setup Device</button>
				</div>
			</form>
		</div>

		<div id="locations" class="screen last-el-bottom">
			<h1>Welcome, <span class="put_name">- </span>!</h1>
			<p>Thank you for all you do to help people find Jesus on campus!  We hope that you'll be encouraged as you celebrate what God has done in and through you by sharing about the following key activities.</p>

			<form class="last-el-bottom" id="location-form">
				<div id="fiftypercent">
					<div>
						<input id="startDate" name="startDate" type="date"><br>
						<label for="startDate">Last Reported Date</label>
					</div>
					<div>
						<input id="endDate" name="endDate" type="date"><br>
						<label for="endDate">Today's Date</label>
					</div>
				</div>

				<h2 id="movementName">University of Central Florida Cru</h2>
				<input type="hidden" id="movementId" name="movementId">

			  <div id="statsList">
					<label for="spiritualConvo">Spiritual Conversations</label>
					<input id="spiritualConvo" type="number" min="0" max="100" step="1" inputmode="numeric">
					<label for="personalEvang">Personal Evangelism</label>
					<input id="personalEvang" type="number" min="0" max="100" step="1"  inputmode="numeric">
					<label for="personalEvangDec">Personal Evangelism Descions</label>
					<input id="personalEvangDec" type="number" min="0" max="100" step="1"  inputmode="numeric">
					<label for="holySpiritPres">Holy Spirit Presentations</label>
					<input id="holySpiritPres" type="number" min="0" max="100" step="1"  inputmode="numeric">
				</div>
				<div>
					<button id="movementSubmit" class="bottom-button">Next</button>
				</div>
			</form>
		</div>

		<div id="summary" class="screen last-el-bottom">
			<h1></h1>

			<div>
				<button href="#"><span>&#128197;</span> Set a calendar reminder</button>
			</div>

			<p style="text-align: center;">Thanks for celebrating with us all that God is doing on Campus! Below is just a small snapshot of what God is doing on your campus in the last 3 weeks.</p>
      
      <div class="cards">
	      <div class="card left">
	      	<img src="gospel.png" width="80px" height="80px">
	      	<p>Your group shared the Gospel with 10 people!</p>
	      </div>
	      <div class="card right">
	      	<img src="spirit.png" width="80px" height="80px">
	      	<p>Your group saw 3 people hear a presentation of the Spirit Filled Life!</p>
	      </div>
	      <div class="card center">
	      	<img src="decision.png" width="80px" height="80px">
	      	<p>Your group saw 2 people indicate a decision to accept Jesus!</p>
	      </div>
	    </div>
      
      <div>
				<button class="bottom-button" onclick="location.hash='';">back</button>
			</div>
		</div>

		<script>
			//SERVICE WORKER
			if ('serviceWorker' in navigator) {
			  navigator.serviceWorker.register('sw.js', {
			    scope: './'
			  })
			  .then((serviceWorker) => {
			    console.log('service worker registration successful');
			  })
			  .catch((err) => {
			    console.error('service worker registration failed');
			    console.error(err);
			  });
			} else {
			  console.log('service worker unavailable');
			}
      
      //HELPER FUNCTIONS FOR USER
			function getUser(){
				return JSON.parse(localStorage.getItem('user'));
			}
			function setUser(user){
				localStorage.setItem('user', JSON.stringify(user));
				return;
			}

      //ADD HASHCHANGE NAV MANAGER
			document.addEventListener("DOMContentLoaded", function(){
	      window.addEventListener("hashchange", hashchanged, false);
	      hashchanged();
	    });

			function hashchanged(){
        var hash = location.hash;
        let projector = document.getElementById('projector');

				//Make sure we've got a user.
				let local_user = getUser();
				if(local_user){
					if(!window.user){
						window.user = local_user;
					}
				}
				else if(hash != '#onboarding'){
					location.hash = "#onboarding";
					return
				}

				//ALL our Redirects
        if(hash == ''){
          projector.classList = 'homepage';
          window.document.title = "Stats Collector";
        }
        else if(hash.startsWith('#onboarding')){
        	projector.classList = 'onboarding';
        	window.document.title = "Let's get you onboarded!";
        }
        else if(hash.startsWith('#locations')){
        	// #locations - start with current location
        	let user = window.user;
        	if(user.locations.length == user.location + 1){
        		$('#movementSubmit').text('Submit');
        	}
        	else{
        		$('#movementSubmit').text('Next');
        	}

        	let movement = user.locations[user.location];
          $('.put_name').text(user.name); 

          $('#movementName').text(movement.name);
          $('#movementId').val(movement.id); //hidden field

        	// #locations/id_number - look up that id and display it - 2.0 capabilities

        	projector.classList = 'locations';
        	window.document.title = "Enter Stats for "+movement.name;
        }
        else if(hash.startsWith('#summary')) {
        	projector.classList = 'summary';
        	window.document.title = "Stats Summary";
        }
      }  
      //PROCESS ONBOARDING FORM
      function processOnboardForm(e) {
		    if (e.preventDefault) e.preventDefault();

		    let user = {};
		    let nameEl = document.getElementById('name');
		    let phoneEl = document.getElementById('phone');
		    user.name = nameEl.value;
		    user.phone = phoneEl.value;
		    user.locations = [];
		    user.location = 0;

		    for(const loc of [{name: 'University at Buffalo', id: 8892920},{name: 'Daemen', id: 8892920}]) {
		    	user.locations.push({name: loc.name, id: loc.id});
		    }
		    setUser(user);
		    window.user = user;
		    location.hash = "#";
        
        //clear form
		    phoneEl.value = '';
		    nameEl.value = '';
		    $('input[type="checkbox"]').prop('checked', false);

		    return false;
			}
			var form = document.getElementById('onboard-form');
			if (form.attachEvent) {
			    form.attachEvent("submit", processOnboardForm);
			} else {
			    form.addEventListener("submit", processOnboardForm);
			}

      //PROCESS LOCATION FORM
      function processLocationForm(e) {
		    if (e.preventDefault) e.preventDefault();
        let user = window.user;
		    //save the data from the form for submittal.

		    //advance the location if not the end one, run hashchange again
		    if(user.locations.length == user.location + 1){
		    	//we're resetting location to 0
		    	window.user.location = 0;
		    	location.hash = "#summary";
		    }
		    else {
		    	window.user.location = user.location + 1;
			    location.hash = "#locations/"+user.locations[user.location].id;
		    }
        
        //clear form
		    $('input[type="checkbox"]').prop('checked', false);
		    $('input[type="number"]').val(0);

			}
			var form = document.getElementById('location-form');
			if (form.attachEvent) {
			    form.attachEvent("submit", processLocationForm);
			} else {
			    form.addEventListener("submit", processLocationForm);
			}


      function addLocationtoList() {
      	let loca = prompt("What's the location's name?");
      	let movement = document.getElementById('movement');
      	movement.insertAdjacentHTML('beforeend', '<option value="" selected>'+ loca + '</option>');
      }

      function summarize() {
      	let inputs = document.querySelectorAll('.screen.active .row.active input');
      	let stats = [];
      	inputs.forEach(function(input) { 
      		if(input.type == 'number'){
      			if(input.value > 0) {
      				stats.push(input.value + ' ' + input.name);
      			}
      			input.value = '';
      		}
      		else if(input.type == 'checkbox') {
      			if(input.checked) {
      				stats.push('1 ' + input.name);	
      			}
      			input.checked = false;
      		}
				});
				let s = ' has';
				if(stats.length > 1) {
          s = 's have';
				}
				let summary = '<h2>'+stats.join(', ') + ' conversation'+s+' been added to your movement!</h2><br><br><br><h2>3 more days until your team gets a new stats score sheet! Check back then :)</h2>';
				document.getElementById('summaryText').innerHTML = summary;
      	location.hash = 'submit';
      	document.querySelectorAll('.active').forEach(function(active) {
      		active.classList.remove('active');
      	});

	      document.getElementById("movement").disabled = true;
	      document.getElementById("summary").scrollTop = 0;
      }
    
		</script>
	</body>
</html>