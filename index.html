<!DOCTYPE html>
<html lang="en">
	<head>
    <meta charset="utf-8"/>
    <meta name="Description" content="Stats Collector">
    <meta name="theme-color" content="#FFCF07">
    <meta name="msapplication-TileColor" content="#FFCF07">

    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="mask-icon" href="safari-pinned-tab.svg" color="#FFCF07">

    <link rel="stylesheet" href="style.css" >

  	<script src="jquery-3.4.0.min.js"></script>

    <title>Stats Collector</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>
	<body id="projector">

		<div id="homepage" class="screen last-el-bottom">
			<h1>Welcome! </h1>
			<p>Welcome message.... Team based? This might be hard to do with version 1 - unless we encode it into the URL  something like: index.html#onboarding="Hi there team!"</p>

			<div>
				<button class="bottom-button" onclick="location.hash = 'locations';">Add Stats</button>
			</div>
		</div>

		<div id="onboarding" class="screen last-el-bottom">
			<h1>Welcome! </h1>
			<p>Select the movements below that you would like to add stats for.  Once this is setup your device will remember your preferences</p>
			<form class="last-el-bottom" id="onboard-form">
				<h2>Movements</h2>

				<div id="movements">
				</div>
				<input id="name" name="name" type="text" required placeholder="Name">
				<input id="phone" name="phone" type="tel" required placeholder="Phone">
				<div>
					<input id="ua" name="ua" required type="checkbox" >
					<label for="ua" >I agree to the <a href="http://google.com" target="_blank">Cru User Agreement</a></label>
				</div>
				<div>
					<button class="bottom-button">Setup Device</button>
				</div>
			</form>
		</div>

		<div id="locations" class="screen last-el-bottom">
			<h1>Welcome, <span class="put_name">- </span>!</h1>
			<p>Thank you for all you do to help people find Jesus on campus!  We hope that you'll be encouraged as you celebrate what God has done in and through you by sharing about the following key activities.</p>

			<form class="last-el-bottom" id="location-form">
				<div id="fiftypercent">
					<div>
						<input id="startDate" name="startDate" type="text" disabled><br>
						<label for="startDate">Last Reported Date</label>
					</div>
					<div>
						<input id="endDate" name="endDate" type="text" disabled><br>
						<label for="endDate">Today's Date</label>
					</div>
				</div>

				<h2 id="movementName">University of Central Florida Cru</h2>
				<input type="hidden" id="movementId" name="movementId">
				<input type="hidden" id="userName" name="userName">
				<input type="hidden" id="userPhone" name="userPhone">

			  <div id="statsList">
			  	<div>
						<label for="spiritualConvo">Spiritual Conversations</label>
						<span rel="tooltip" title="How many Spiritual Conversations have you engaged in whether you did or did not present the gospel and bring them to a point of decision. (Each time you engage the same person count it.)">i</span>
					</div>
					<div>
						<span class="dec button">-</span>
						<input id="spiritualConvo" name="spiritualConvo" type="number" min="0" max="100" step="1" inputmode="numeric" value="0">
						<span class="inc button">+</span>
					</div>
					<div>
						<label for="personalEvang">Personal Evangelism</label>
						<span rel="tooltip" title="How many gospel presentations through personal evangelism, where you brought him/her to a point of decision? (Each time you share the gospel with the same person count it) (Includes staff, student, faculty & volunteer evangelism and personal internet evangelism)">i</span>
					</div>
					<div>
						<span class="dec button">-</span>
						<input id="personalEvang" name="personalEvang" type="number" min="0" max="100" step="1"  inputmode="numeric" value="0">
						<span class="inc button">+</span>
					</div>
					<div>
						<label for="personalEvangDec">Personal Evangelism Decisions</label>
						<span rel="tooltip" title="How many people have indicated a decision to receive Christ as their Savior and Lord after hearing a personal presentation of the gospel?">i</span>
					</div>
					<div>
						<span class="dec button">-</span>
						<input id="personalEvangDec" name="personalEvangDec" type="number" min="0" max="100" step="1"  inputmode="numeric" value="0">
						<span class="inc button">+</span>
					</div>
					<div>
						<label for="holySpiritPres">Holy Spirit Presentations</label>
						<span rel="tooltip" title="How many people have heard a presentation of the ministry of the Holy Spirit and been given the opportunity to respond?">i</span>
					</div>
					<div>
						<span class="dec button">-</span>
						<input id="holySpiritPres" name="holySpiritPres" type="number" min="0" max="100" step="1"  inputmode="numeric" value="0">
						<span class="inc button">+</span>
					</div>
				</div>
				<div>
					<button id="movementSubmit" class="bottom-button">Next</button>
				</div>
			</form>
		</div>

		<div id="summary" class="screen last-el-bottom">
			<h1></h1>

			<div>
				<button href="#"><span>&#128197;</span> Set a calendar reminder</button>
			</div>

			<p style="text-align: center;">Thanks for celebrating with us all that God is doing on Campus! Below is just a small snapshot of what God is doing on your campus in the last 3 weeks.</p>
      
      <div class="cards">
	      <div class="card left">
	      	<img src="gospel.png" width="80px" height="80px">
	      	<p>Your group shared the Gospel with 10 people!</p>
	      </div>
	      <div class="card right">
	      	<img src="spirit.png" width="80px" height="80px">
	      	<p>Your group saw 3 people hear a presentation of the Spirit Filled Life!</p>
	      </div>
	      <div class="card center">
	      	<img src="decision.png" width="80px" height="80px">
	      	<p>Your group saw 2 people indicate a decision to accept Jesus!</p>
	      </div>
	    </div>
      
      <div>
				<button class="bottom-button" onclick="location.hash='';">back</button>
			</div>
		</div>

		<div id="spin-container">
			<div id="spinner">
			</div>
		</div>

		<script>
			//SERVICE WORKER
			if ('serviceWorker' in navigator) {
			  navigator.serviceWorker.register('sw.js', {
			    scope: './'
			  })
			  .then((serviceWorker) => {
			    console.log('service worker registration successful');
			  })
			  .catch((err) => {
			    console.error('service worker registration failed');
			    console.error(err);
			  });
			} else {
			  console.log('service worker unavailable');
			}
      
      //HELPER FUNCTIONS FOR USER
			function getUser(){
				return JSON.parse(localStorage.getItem('user'));
			}
			function setUser(user){
				localStorage.setItem('user', JSON.stringify(user));
				return;
			}

      //INITIALIZE HASHCHANGE AND LOAD MOVEMENT LIST INTO MEMORY
			document.addEventListener("DOMContentLoaded", function(){
	      window.addEventListener("hashchange", hashchanged, false);
	      hashchanged();
	    });

	    async function loadMovements(){
	    	startSpin();
				var jqxhr = await $.ajax({
			    url: "https://script.google.com/a/cru.org/macros/s/AKfycbyLKAjuQwwDy2j2s_rfg2NiRrOO-jUyJbVKxuGi/exec",
			    method: "GET",
			    dataType: "json",
			    data: "movements=true"
			  }).done(function(data){
			    window.movementsList = data;
			  });
			  stopSpin();
			  return jqxhr;
	    }

	    async function registerUser(){
	    	startSpin();
				var jqxhr = await $.ajax({
			    url: "https://script.google.com/a/cru.org/macros/s/AKfycbyLKAjuQwwDy2j2s_rfg2NiRrOO-jUyJbVKxuGi/exec",
			    method: "GET",
			    dataType: "json",
			    data: "registerUser=true&userPhone=8253320550&userName=Jimmy%20Mg&userIds=20,390"
			  }).done(function(data){
			  	console.log(data);
			    //window.movementsList = data;
			  });
			  stopSpin();
			  return jqxhr;
	    }
	    async function requestUser(){
	    	startSpin();
				var jqxhr = await $.ajax({
			    url: "https://script.google.com/a/cru.org/macros/s/AKfycbyLKAjuQwwDy2j2s_rfg2NiRrOO-jUyJbVKxuGi/exec",
			    method: "GET",
			    dataType: "json",
			    data: "requestUser=true&userPhone=8453320550"
			  }).done(function(data){
			  	console.log(data);
			    //window.movementsList = data;
			  });
			  stopSpin();
			  return jqxhr;
	    }

			async function hashchanged(){
        var hash = location.hash;
        let projector = document.getElementById('projector');

				//Make sure we've got a user.
				let local_user = getUser();
				if(local_user){
					if(!window.user){
						window.user = local_user;
					}
				}
				else if(!hash.startsWith('#onboarding')){
					location.hash = "#onboarding";
					return
				}

				//ALL our Redirects
        if(hash == ''){
          projector.classList = 'homepage';
          window.document.title = "Stats Collector";
        }
        else if(hash.startsWith('#onboarding')){
        	let movements = hash.split('/')[1].split('&');

        	//CHeck if all movements are already added... if so move to homepage or stats addition
					
					let movementsList = await loadMovements();
					console.log('loaded movements');
					
					$('#movements').empty();
        	for(movement of movements) {
            $('#movements').append('<input id="n'+movement+'" name="'+movement+'" type="checkbox" ><label for="n'+movement+'" >'+window.movementsList[movement]+'</label>');
        	} 
        	projector.classList = 'onboarding';
        	window.document.title = "Let's get you onboarded!";
        }
        else if(hash.startsWith('#locations')){
        	// #locations - start with current location
        	let user = window.user;
        	if(user.location == 0) {
        		window.formSubs = [];
        	}

        	if(user.locations.length == user.location + 1){
        		$('#movementSubmit').text('Submit');
        	}
        	else{
        		$('#movementSubmit').text('Next');
        	}

        	var movement = user.locations[user.location];
          $('.put_name').text(user.name); 
          $('#movementName').text(movement.name);
          $('#movementId').val(movement.id); //hidden field
          $('#userName').val(user.name); //hidden field
          $('#userPhone').val(user.phone); //hidden field

          // set dates for the movement
          let endDate = new Date().toLocaleString().split(',')[0];
          let startDate = new Date(Date.now() - 14*24*60*60*1000).toLocaleString().split(',')[0];

          $('#startDate').val(startDate);
          $('#endDate').val(endDate);

        	// #locations/id_number - look up that id and display it - 2.0 capabilities

        	projector.classList = 'locations';
        	window.document.title = "Enter Stats for "+movement.name;
        }
        else if(hash.startsWith('#summary')) {
        	projector.classList = 'summary';
        	window.document.title = "Stats Summary";
        }
      }  
      //PROCESS ONBOARDING FORM
      function processOnboardForm(e) {
		    if (e.preventDefault) e.preventDefault();

		    let user = {};
		    let nameEl = document.getElementById('name');
		    let phoneEl = document.getElementById('phone');
		    user.name = nameEl.value;
		    user.phone = phoneEl.value;
		    user.locations = [];
		    user.location = 0;

        $('#movements input').each(function(){
        	if(this.checked) {
	          user.locations.push({name: $(this).next().text(), id: this.name})
        	}
        	else {
        		console.log('not checked');
        	}
        });

		    //overwrites whatever is there... if username and phone are same, let's add new movements? If user exists, let's load the user name and phone to preload...
		    setUser(user);
		    window.user = user;
		    location.hash = "#";
        
        //clear form
		    phoneEl.value = '';
		    nameEl.value = '';
		    $('input[type="checkbox"]').prop('checked', false);

		    return false;
			}
			var form = document.getElementById('onboard-form');
			if (form.attachEvent) {
			    form.attachEvent("submit", processOnboardForm);
			} else {
			    form.addEventListener("submit", processOnboardForm);
			}

      //PROCESS LOCATION FORM
      async function processLocationForm(e) {
		    if (e.preventDefault) e.preventDefault();
        let user = window.user;
		    //save the data from the form for submittal later
		    var form = $('#location-form'),
            url  =  "https://script.google.com/a/cru.org/macros/s/AKfycbyLKAjuQwwDy2j2s_rfg2NiRrOO-jUyJbVKxuGi/exec"

				var disabled = form.find(':input:disabled').removeAttr('disabled');
				window.formSubs.push(form.serialize());
        disabled.attr('disabled','disabled');

		    //advance the location if not the end one, run hashchange again
		    if(user.locations.length == user.location + 1){
			    startSpin();

		    	//we're resetting location to 0
		    	window.user.location = 0;
		    	//submit everything - can we do this in one go?
		    	for(movement of window.formSubs){
		    		var jqxhr = await $.ajax({
					    url: url,
					    method: "GET",
					    dataType: "json",
					    data: movement
					  }).done(function(data){
					    console.log(data);
					  });
				    //THen change the location
			    	location.hash = "#summary";
			    	stopSpin();
		    	}
		    }
		    else {
		    	window.user.location = user.location + 1;
			    location.hash = "#locations/"+user.locations[user.location].id;
		    }
        
        //clear form
		    $('input[type="checkbox"]').prop('checked', false);
		    $('input[type="number"]').val(0);

			}
			var form = document.getElementById('location-form');
			if (form.attachEvent) {
			    form.attachEvent("submit", processLocationForm);
			} else {
			    form.addEventListener("submit", processLocationForm);
			}
      function startSpin() {
        document.getElementById('spin-container').classList = "spin";
      }
      function stopSpin() {	
        document.getElementById('spin-container').classList = "";
      }

      function addLocationtoList() {
      	let loca = prompt("What's the location's name?");
      	let movement = document.getElementById('movement');
      	movement.insertAdjacentHTML('beforeend', '<option value="" selected>'+ loca + '</option>');
      }

      function summarize() {
      	let inputs = document.querySelectorAll('.screen.active .row.active input');
      	let stats = [];
      	inputs.forEach(function(input) { 
      		if(input.type == 'number'){
      			if(input.value > 0) {
      				stats.push(input.value + ' ' + input.name);
      			}
      			input.value = '';
      		}
      		else if(input.type == 'checkbox') {
      			if(input.checked) {
      				stats.push('1 ' + input.name);	
      			}
      			input.checked = false;
      		}
				});
				let s = ' has';
				if(stats.length > 1) {
          s = 's have';
				}
				let summary = '<h2>'+stats.join(', ') + ' conversation'+s+' been added to your movement!</h2><br><br><br><h2>3 more days until your team gets a new stats score sheet! Check back then :)</h2>';
				document.getElementById('summaryText').innerHTML = summary;
      	location.hash = 'submit';
      	document.querySelectorAll('.active').forEach(function(active) {
      		active.classList.remove('active');
      	});

	      document.getElementById("movement").disabled = true;
	      document.getElementById("summary").scrollTop = 0;
      }
      //add +/- buttons to input[type="number"]
      $(".button").on("click", function() {
			  let $button = $(this);
			  let oldValue = $button.parent().find("input").val();
			  if ($button.text() == "+") {
				  var newVal = parseFloat(oldValue) + 1;
				} else {
			   // Don't allow decrementing below zero
			    if (oldValue > 0) {
			      var newVal = parseFloat(oldValue) - 1;
			    } else {
			      newVal = 0;
			    }
			  }
			  $button.parent().find("input").val(newVal);
			});

      //TOOLTIP CODE
      $( function() {
		    var targets = $( '[rel~=tooltip]' ), 
	        target  = false,
	        tooltip = false,
	        title   = false;
	 
		    targets.bind( 'mouseenter', function() {
	        target  = $( this );
	        tip     = target.attr( 'title' );
	        tooltip = $( '<div id="tooltip"></div>' );
 
	        if( !tip || tip == '' ) {
	          return false;
	        }
 
	        target.removeAttr( 'title' );
	        tooltip.css( 'opacity', 0 )
	               .html( tip )
	               .appendTo( 'body' );
 
	        var init_tooltip = function() {
            if( $( window ).width() < tooltip.outerWidth() * 1.5 ) {
              tooltip.css( 'max-width', $( window ).width() / 2 );
            }
            else {
              tooltip.css( 'max-width', 340 );
            }
 
            var pos_left = target.offset().left + ( target.outerWidth() / 2 ) - ( tooltip.outerWidth() / 2 );
            var pos_top  = target.offset().top - tooltip.outerHeight() - 20;
 
            if( pos_left < 0 )
            {
              pos_left = target.offset().left + target.outerWidth() / 2 - 20;
              tooltip.addClass( 'left' );
            }
            else {
              tooltip.removeClass( 'left' );
            }
 
            if( pos_left + tooltip.outerWidth() > $( window ).width() ) {
              pos_left = target.offset().left - tooltip.outerWidth() + target.outerWidth() / 2 + 20;
              tooltip.addClass( 'right' );
            }
            else {
              tooltip.removeClass( 'right' );
            }
 
            if( pos_top < 0 ) {
              var pos_top  = target.offset().top + target.outerHeight();
              tooltip.addClass( 'top' );
            }
            else {
              tooltip.removeClass( 'top' );
            }
 
            tooltip.css( { left: pos_left, top: pos_top } ).animate( { top: '+=10', opacity: 1 }, 50 );
	        };
	 
	        init_tooltip();
	        $( window ).resize( init_tooltip );
	 
	        var remove_tooltip = function() {
            tooltip.animate( { top: '-=10', opacity: 0 }, 50, function() {
              $( this ).remove();
            });
 
            target.attr( 'title', tip );
	        };
	 
	        target.bind( 'mouseleave', remove_tooltip );
	        tooltip.bind( 'click', remove_tooltip );
		    });
			});
    
		</script>
	</body>
</html>